<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .question-item {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #f9fafb;
        }
        .option-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>

<body class="bg-gray-100">
    <nav class="bg-blue-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="/admin" class="text-white text-xl font-bold">Edemy Admin</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/admin" class="text-white hover:text-blue-200 px-3 py-2 rounded-md text-sm font-medium">
                        Dashboard
                    </a>
                    <a href="/admin/users"
                        class="text-white hover:text-blue-200 px-3 py-2 rounded-md text-sm font-medium">
                        Users
                    </a>
                    <a href="/admin/courses"
                        class="text-white hover:text-blue-200 px-3 py-2 rounded-md text-sm font-medium">
                        Courses
                    </a>
                    <a href="/admin/quizzes" class="text-white bg-blue-800 px-3 py-2 rounded-md text-sm font-medium">
                        Quizzes
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 px-4">
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Quiz Management</h1>
                        <p class="text-sm text-gray-500 mt-1">Total Quizzes: <span class="font-semibold text-green-600"><%= quizzes.length %></span></p>
                    </div>
                    <button onclick="openCreateModal()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                        + Create New Quiz
                    </button>
                </div>

                <!-- Quizzes List -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="quizzesList">
                    <% quizzes.forEach((quiz) => { %>
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                            <div class="p-6">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-1"><%= quiz.title %></h3>
                                        <% if (quiz.subtitle) { %>
                                            <p class="text-sm text-gray-600 mb-2"><%= quiz.subtitle %></p>
                                        <% } %>
                                        <p class="text-xs text-gray-500">Course: <%= quiz.courseName %></p>
                                    </div>
                                    <span class="<%= quiz.isPublished ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' %> text-xs font-medium px-2 py-1 rounded-full">
                                        <%= quiz.isPublished ? 'Published' : 'Draft' %>
                                    </span>
                                </div>

                                <div class="space-y-2 mb-4">
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="font-medium">Questions:</span>
                                        <span class="ml-2"><%= quiz.questions?.length || quiz.totalQuestions || 0 %></span>
                                    </div>
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="font-medium">Time Limit:</span>
                                        <span class="ml-2"><%= quiz.timeLimit %> minutes</span>
                                    </div>
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="font-medium">Pass Mark:</span>
                                        <span class="ml-2"><%= quiz.passMark %>%</span>
                                    </div>
                                    <div class="flex items-center text-sm text-gray-600">
                                        <span class="font-medium">Total Points:</span>
                                        <span class="ml-2"><%= quiz.totalPoints %></span>
                                    </div>
                                </div>

                                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-100">
                                    <button onclick='editQuiz("<%= quiz._id %>")' 
                                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium py-2 px-3 rounded">
                                        Edit
                                    </button>
                                    <button onclick='deleteQuiz("<%= quiz._id %>")' 
                                        class="flex-1 bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded">
                                        Delete
                                    </button>
                                </div>

                                <div class="text-xs text-gray-500 mt-3">
                                    Created: <%= new Date(quiz.createdAt).toLocaleDateString() %>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>

                <% if (quizzes.length === 0) { %>
                    <div class="text-center py-12">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No quizzes found</h3>
                        <p class="text-gray-500 mb-4">Create your first quiz to get started.</p>
                        <button onclick="openCreateModal()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                            Create Quiz
                        </button>
                    </div>
                <% } %>
            </div>
        </div>
    </main>

    <!-- Create/Edit Quiz Modal -->
    <div id="quizModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-900" id="modalTitle">Create New Quiz</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>

                <form id="quizForm" onsubmit="handleSubmit(event)">
                    <input type="hidden" id="quizId" name="quizId">

                    <!-- Basic Information -->
                    <div class="bg-gray-50 p-6 rounded-lg mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h4>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quiz Title *</label>
                            <input type="text" id="title" name="title" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subtitle</label>
                            <input type="text" id="subtitle" name="subtitle"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                            <textarea id="description" name="description" rows="3" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Course *</label>
                                <select id="courseId" name="courseId" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select a course</option>
                                    <% courses.forEach((course) => { %>
                                        <option value="<%= course._id %>"><%= course.title %></option>
                                    <% }); %>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Time Limit (minutes) *</label>
                                <input type="number" id="timeLimit" name="timeLimit" min="1" required value="30"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pass Mark (%) *</label>
                                <input type="number" id="passMark" name="passMark" min="0" max="100" required value="70"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Instructions</label>
                                <textarea id="instructions" name="instructions" rows="2"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">Read each question carefully and select the best answer.</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Learning Outcomes -->
                    <div class="bg-gray-50 p-6 rounded-lg mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Learning Outcomes</h4>
                        <div id="learningOutcomesContainer">
                            <div class="mb-2 flex gap-2">
                                <input type="text" name="learningOutcome" placeholder="What students will learn/test"
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" onclick="addLearningOutcome()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">Add</button>
                            </div>
                            <div id="learningOutcomesList" class="space-y-2"></div>
                        </div>
                    </div>

                    <!-- Quiz Settings -->
                    <div class="bg-gray-50 p-6 rounded-lg mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Quiz Settings</h4>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="isPublished" name="isPublished" class="mr-2">
                                <span class="text-sm text-gray-700">Publish Quiz</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="allowRetakes" name="allowRetakes" checked class="mr-2">
                                <span class="text-sm text-gray-700">Allow Retakes</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="showAnswersAfterSubmission" name="showAnswersAfterSubmission" checked class="mr-2">
                                <span class="text-sm text-gray-700">Show Answers After Submission</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="randomizeQuestions" name="randomizeQuestions" class="mr-2">
                                <span class="text-sm text-gray-700">Randomize Question Order</span>
                            </label>
                        </div>
                    </div>

                    <!-- Questions Section -->
                    <div class="bg-gray-50 p-6 rounded-lg mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900">Questions</h4>
                                <p class="text-sm text-gray-600 mt-1" id="questionsSummary">
                                    Total: 0 | Valid: 0 | Incomplete: 0
                                </p>
                            </div>
                            <button type="button" onclick="addQuestion()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                                + Add Question
                            </button>
                        </div>
                        <div id="questionsContainer"></div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Save Quiz
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let learningOutcomes = [];
        let questions = [];
        let questionCounter = 0;

        // Fetch courses for dropdown
        async function fetchCourses() {
            try {
                const response = await fetch('/api/courses');
                const courses = await response.json();
                return courses;
            } catch (error) {
                console.error('Error fetching courses:', error);
                return [];
            }
        }

        function openCreateModal(courseId = null) {
            document.getElementById('modalTitle').textContent = 'Create New Quiz';
            document.getElementById('quizForm').reset();
            document.getElementById('quizId').value = '';
            learningOutcomes = [];
            questions = [];
            questionCounter = 0;
            if (courseId) {
                document.getElementById('courseId').value = courseId;
            }
            updateLearningOutcomesDisplay();
            updateQuestionsDisplay();
            document.getElementById('quizModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('quizModal').classList.add('hidden');
        }

        async function editQuiz(quizId) {
            try {
                const response = await fetch(`/api/quizzes/${quizId}`);
                const quiz = await response.json();
                
                document.getElementById('modalTitle').textContent = 'Edit Quiz';
                document.getElementById('quizId').value = quiz._id;
                document.getElementById('title').value = quiz.title;
                document.getElementById('subtitle').value = quiz.subtitle || '';
                document.getElementById('description').value = quiz.description;
                document.getElementById('courseId').value = quiz.courseId._id || quiz.courseId;
                document.getElementById('timeLimit').value = quiz.timeLimit;
                document.getElementById('passMark').value = quiz.passMark;
                document.getElementById('instructions').value = quiz.instructions || '';
                document.getElementById('isPublished').checked = quiz.isPublished;
                document.getElementById('allowRetakes').checked = quiz.allowRetakes;
                document.getElementById('showAnswersAfterSubmission').checked = quiz.showAnswersAfterSubmission;
                document.getElementById('randomizeQuestions').checked = quiz.randomizeQuestions;

                learningOutcomes = quiz.learningOutcomes || [];
                questions = (quiz.questions || []).map((q, idx) => ({
                    id: idx,
                    questionText: q.questionText || '',
                    questionType: q.questionType || 'multiple-choice',
                    points: q.points || 1,
                    options: q.options && q.options.length > 0 ? q.options : [
                        { text: '', isCorrect: false },
                        { text: '', isCorrect: false },
                        { text: '', isCorrect: false },
                        { text: '', isCorrect: false }
                    ],
                    correctAnswer: q.correctAnswer || '',
                    explanation: q.explanation || ''
                }));
                questionCounter = questions.length;

                updateLearningOutcomesDisplay();
                updateQuestionsDisplay();
                document.getElementById('quizModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error fetching quiz:', error);
                alert('Error loading quiz data');
            }
        }

        function addLearningOutcome() {
            const input = document.querySelector('input[name="learningOutcome"]');
            if (input.value.trim()) {
                learningOutcomes.push(input.value.trim());
                input.value = '';
                updateLearningOutcomesDisplay();
            }
        }

        function removeLearningOutcome(index) {
            learningOutcomes.splice(index, 1);
            updateLearningOutcomesDisplay();
        }

        function updateLearningOutcomesDisplay() {
            const container = document.getElementById('learningOutcomesList');
            container.innerHTML = learningOutcomes.map((outcome, index) => `
                <div class="flex items-center justify-between bg-white p-2 rounded border">
                    <span class="text-sm text-gray-700">${outcome}</span>
                    <button type="button" onclick="removeLearningOutcome(${index})" 
                        class="text-red-500 hover:text-red-700 text-sm">Remove</button>
                </div>
            `).join('');
        }

        function addQuestion() {
            const question = {
                id: questionCounter++,
                questionText: '',
                questionType: 'multiple-choice',
                points: 1,
                options: [
                    { text: '', isCorrect: false },
                    { text: '', isCorrect: false },
                    { text: '', isCorrect: false },
                    { text: '', isCorrect: false }
                ],
                correctAnswer: '',
                explanation: ''
            };
            questions.push(question);
            updateQuestionsDisplay();
        }

        function changeQuestionType(qIndex, newType) {
            questions[qIndex].questionType = newType;
            if (newType === 'true-false') {
                questions[qIndex].options = [
                    { text: 'True', isCorrect: false },
                    { text: 'False', isCorrect: false }
                ];
            } else if (newType === 'multiple-choice' && questions[qIndex].options.length < 2) {
                questions[qIndex].options = [
                    { text: '', isCorrect: false },
                    { text: '', isCorrect: false },
                    { text: '', isCorrect: false },
                    { text: '', isCorrect: false }
                ];
            }
            updateQuestionsDisplay();
        }

        function removeQuestion(index) {
            questions.splice(index, 1);
            updateQuestionsDisplay();
        }

        function addOption(questionIndex) {
            questions[questionIndex].options.push({ text: '', isCorrect: false });
            updateQuestionsDisplay();
        }

        function removeOption(questionIndex, optionIndex) {
            questions[questionIndex].options.splice(optionIndex, 1);
            updateQuestionsDisplay();
        }

        function updateQuestionsDisplay() {
            const container = document.getElementById('questionsContainer');
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No questions added yet. Click "Add Question" to get started.</p>';
                return;
            }

            // Update summary
            const validCount = questions.filter(q => 
                q.questionText && q.questionText.trim() && 
                (q.questionType === 'short-answer' || (q.options && q.options.filter(opt => opt.text && opt.text.trim()).length >= 2))
            ).length;
            const summaryEl = document.getElementById('questionsSummary');
            if (summaryEl) {
                summaryEl.textContent = `Total: ${questions.length} | Valid: ${validCount} | Incomplete: ${questions.length - validCount}`;
            }

            container.innerHTML = questions.map((question, qIndex) => {
                const isValid = question.questionText && question.questionText.trim() && 
                               (question.questionType === 'short-answer' || (question.options && question.options.filter(opt => opt.text && opt.text.trim()).length >= 2));
                return `
                <div class="question-item ${!isValid ? 'border-red-300 bg-red-50' : ''}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2">
                            <h5 class="font-semibold text-gray-900">Question ${qIndex + 1}</h5>
                            ${!isValid ? '<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">⚠ Incomplete</span>' : '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">✓ Valid</span>'}
                        </div>
                        <button type="button" onclick="removeQuestion(${qIndex})" 
                            class="text-red-500 hover:text-red-700 text-sm">Remove</button>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Text *</label>
                        <textarea onchange="questions[${qIndex}].questionText = this.value; updateQuestionsDisplay();" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                            required>${question.questionText || ''}</textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Question Type *</label>
                            <select onchange="changeQuestionType(${qIndex}, this.value)" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="multiple-choice" ${question.questionType === 'multiple-choice' ? 'selected' : ''}>Multiple Choice</option>
                                <option value="true-false" ${question.questionType === 'true-false' ? 'selected' : ''}>True/False</option>
                                <option value="short-answer" ${question.questionType === 'short-answer' ? 'selected' : ''}>Short Answer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Points *</label>
                            <input type="number" onchange="questions[${qIndex}].points = parseInt(this.value)" 
                                value="${question.points}" min="1" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                    </div>

                    ${question.questionType === 'short-answer' ? `
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Correct Answer *</label>
                            <input type="text" onchange="questions[${qIndex}].correctAnswer = this.value" 
                                value="${question.correctAnswer || ''}" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                    ` : `
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Options *</label>
                            ${question.options.map((option, oIndex) => `
                                <div class="option-item">
                                    <input type="radio" 
                                        name="correct_${qIndex}" 
                                        ${option.isCorrect ? 'checked' : ''}
                                        onchange="questions[${qIndex}].options.forEach((opt, idx) => {
                                            opt.isCorrect = (idx === ${oIndex});
                                        });
                                        updateQuestionsDisplay();"
                                        class="mr-2">
                                    <span class="text-xs text-gray-500 mr-2">✓ Correct</span>
                                    <input type="text" onchange="questions[${qIndex}].options[${oIndex}].text = this.value; updateQuestionsDisplay();" 
                                        value="${option.text}" placeholder="Option ${oIndex + 1}" 
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md" required>
                                    ${question.questionType !== 'true-false' && question.options.length > 2 ? `
                                        <button type="button" onclick="removeOption(${qIndex}, ${oIndex})" 
                                            class="text-red-500 hover:text-red-700 text-sm">Remove</button>
                                    ` : ''}
                                </div>
                            `).join('')}
                            ${question.questionType !== 'true-false' ? `
                                <button type="button" onclick="addOption(${qIndex})" 
                                    class="mt-2 text-blue-500 hover:text-blue-700 text-sm">+ Add Option</button>
                            ` : ''}
                        </div>
                    `}

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Explanation (shown after submission)</label>
                        <textarea onchange="questions[${qIndex}].explanation = this.value" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                            rows="2">${question.explanation || ''}</textarea>
                    </div>
                </div>
            `;
            }).join('');
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            const formData = {
                title: document.getElementById('title').value,
                subtitle: document.getElementById('subtitle').value,
                description: document.getElementById('description').value,
                courseId: document.getElementById('courseId').value,
                timeLimit: parseInt(document.getElementById('timeLimit').value),
                passMark: parseInt(document.getElementById('passMark').value),
                instructions: document.getElementById('instructions').value,
                learningOutcomes: learningOutcomes,
                questions: questions
                    .filter(q => q.questionText && q.questionText.trim()) // Filter out questions with empty text
                    .map(q => ({
                        questionText: q.questionText.trim(),
                        questionType: q.questionType,
                        points: parseInt(q.points) || 1,
                        options: q.options.filter(opt => opt.text && opt.text.trim()),
                        correctAnswer: q.correctAnswer ? q.correctAnswer.trim() : '',
                        explanation: q.explanation ? q.explanation.trim() : ''
                    })),
                isPublished: document.getElementById('isPublished').checked,
                allowRetakes: document.getElementById('allowRetakes').checked,
                showAnswersAfterSubmission: document.getElementById('showAnswersAfterSubmission').checked,
                randomizeQuestions: document.getElementById('randomizeQuestions').checked
            };

            // Validation
            if (formData.questions.length === 0) {
                alert('Please add at least one question with question text');
                return;
            }

            // Validate each question has required fields
            for (let i = 0; i < formData.questions.length; i++) {
                const q = formData.questions[i];
                if (!q.questionText || !q.questionText.trim()) {
                    alert(`Question ${i + 1} is missing question text. Please fill in all questions or remove empty ones.`);
                    return;
                }
                if (q.questionType !== 'short-answer' && (!q.options || q.options.length < 2)) {
                    alert(`Question ${i + 1} must have at least 2 options.`);
                    return;
                }
                if (q.questionType === 'short-answer' && !q.correctAnswer) {
                    alert(`Question ${i + 1} (Short Answer) must have a correct answer.`);
                    return;
                }
            }

            console.log('Submitting quiz with', formData.questions.length, 'questions');

            const quizId = document.getElementById('quizId').value;
            const url = quizId ? `/api/quizzes/${quizId}` : '/api/quizzes';
            const method = quizId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    // Show success message
                    showSuccessMessage(quizId ? 'Quiz updated successfully!' : 'Quiz created successfully!');
                    // Close modal
                    closeModal();
                    // Reload page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.message || 'Failed to save quiz'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving quiz');
            }
        }

        async function deleteQuiz(quizId) {
            if (!confirm('Are you sure you want to delete this quiz? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/quizzes/${quizId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showSuccessMessage('Quiz deleted successfully!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.message || 'Failed to delete quiz'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting quiz');
            }
        }

        // Success message display
        function showSuccessMessage(message) {
            // Remove existing success message if any
            const existingMsg = document.getElementById('successMessage');
            if (existingMsg) {
                existingMsg.remove();
            }

            // Create success message element
            const successMsg = document.createElement('div');
            successMsg.id = 'successMessage';
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';
            successMsg.innerHTML = `
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(successMsg);

            // Remove message after 3 seconds
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }

        // Check URL parameters on page load
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('courseId');
            const success = urlParams.get('success');
            
            if (success === 'true') {
                showSuccessMessage('Quiz created successfully!');
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (courseId) {
                // Auto-open modal with course pre-selected
                openCreateModal(courseId);
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // Initialize
        updateQuestionsDisplay();
    </script>
</body>

</html>

